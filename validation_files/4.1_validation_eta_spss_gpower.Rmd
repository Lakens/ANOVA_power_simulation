---
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
nsims <- 10000 #set number of simulations
library(mvtnorm)
library(afex)
library(emmeans)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(pwr)

# Install functions from GitHub by running the code below:
source("https://raw.githubusercontent.com/Lakens/ANOVA_power_simulation/master/ANOVA_design.R")
source("https://raw.githubusercontent.com/Lakens/ANOVA_power_simulation/master/ANOVA_power.R")
source("https://raw.githubusercontent.com/Lakens/ANOVA_power_simulation/master/mu_from_ES.R")

```

## Partial eta-squared in SPSS and GPower

We can simulate within designs and calculate eta-squared. We set groups to 3 for the simulation, n = 20, and the correlation between dependent variables to 0.8. If the true effect size is f = 0.1, and the alpha level is 0.05, the power is 80.16%. 


```{r}
k <- 1
m <- 3
n <- 66
sd <- 1
r <- 0.8
alpha = 0.05
f <- 0.1
f2 <- f^2
ES <- f2/(f2+1)
ES

mu <- mu_from_ES(K = m, ES = ES) #Note the K = m - renaming K to number of measurements m, not number of groups, k.

mu <- c(0, 0.2121321, 0.2121321)
sqrt(sum((mu-mean(mu))^2)/length(mu))/sd #Cohen, 1988, formula 8.2.1 and 8.2.2

string = paste(m,"w",sep="")
p_adjust = "none"
labelnames <- c("speed", "fast", "medium", "slow")

design_result <- ANOVA_design(string = string,
                   n = n, 
                   mu = mu, 
                   sd = sd, 
                   r = r, 
                   p_adjust = "none",
                   labelnames = labelnames)

alpha_level <- 0.05

ANOVA_power(design_result, nsims = nsims)
#medium variability w 1000
#79.3
#79.6
#maximum variability w 1000
#80.5
#81.2
#maximum variability w 10000
#80.46
#80.03

#eta = 0.0786
```

The results of the simulation are indeed very close to 80.16%. 

If we take a look at the eta-squared effect size estimate, we see it is XX.XX. This illustrates the formula $f=\sqrt{\frac{(\eta}{(1-\eta)}}$ does not hold for within designs. 

From the G*power manual: 

Note that the partial eta^2 given by G*Power is calculated from f according to the formula h2 = f^2/(1 + f^2) and is notidentical to the SPSS partial eta^2, which is based on sample estimates. The relation between the two is “SPSS eta^2" = eta^2N/(N + k(eta^2 􀀀 1)), where N denotes the total sample
size, k the total number of groups in the design and eta^2 the G*Power value. Thus eta^2 0 = 0.33306806 x 108/(108 - 36 + 0.33306806 x 36) = 0.42828, which is the value given in the SPSS output.





```{r}

k <- 1
m <- 3
n <- 66
sd <- 1
r <- 0.8
alpha = 0.05

eta <- 0.2357023
f_SPSS_squared <- eta/(1-eta)
f_SPSS_squared

f_gpower_squared <- f_SPSS_squared * ((n-k)/n) * ((m-1)/m) * (1-r)

eta_gpower <- f_gpower_squared / (f_gpower_squared + 1)
eta_gpower
```

$f_{G*Power}^{2}=f_{SPSS}^{2}\times\frac{N-k}{N}\times\frac{(m-1)}{m}\times(1-\rho)$



```{r}
k <- 1
m <- 3
n <- 20
sd <- 1
r <- 0.8
alpha = 0.05

mu <- c(0, 0.5, 0.5)
sqrt(sum((mu-mean(mu))^2)/length(mu))/sd #Cohen, 1988, formula 8.2.1 and 8.2.2

string = paste(m,"w",sep="")
p_adjust = "none"
labelnames <- c("speed", "fast", "medium", "slow")

design_result <- ANOVA_design(string = string,
                   n = n, 
                   mu = mu, 
                   sd = sd, 
                   r = r, 
                   p_adjust = "none",
                   labelnames = labelnames)

alpha_level <- 0.05

ANOVA_power(design_result, nsims = nsims)


eta <- 0.3096
f_SPSS_squared <- eta/(1-eta)
f_SPSS_squared

f_gpower_squared <- f_SPSS_squared * ((n-k)/n) * ((m-1)/m) * (1-r)

eta_gpower <- f_gpower_squared / (f_gpower_squared + 1)
eta_gpower



```

